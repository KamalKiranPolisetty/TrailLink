# üöÄ TrailLink Deployment Guide

This guide will help you deploy TrailLink to production environments.

## üìã Prerequisites

- Node.js 18+ and npm
- Docker and Docker Compose
- MongoDB Atlas account (or self-hosted MongoDB)
- Domain name and SSL certificates
- Expo account for mobile app deployment

## üîß Quick Setup

### 1. Run the Production Setup Script

```bash
# Make scripts executable (if not already)
chmod +x scripts/setup-production.sh scripts/deploy.sh

# Run the setup script
./scripts/setup-production.sh
```

This script will:
- Generate secure JWT and session secrets
- Create environment files from templates
- Install all dependencies
- Set up EAS project for mobile deployment
- Create necessary directories
- Generate development SSL certificates

### 2. Configure Environment Variables

#### Backend Configuration (`backend/.env`)

Update the following values in `backend/.env`:

```env
# Database - Replace with your MongoDB Atlas connection string
MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/traillink?retryWrites=true&w=majority

# CORS Origin - Replace with your frontend URL
CORS_ORIGIN=https://your-frontend-url.com

# Other values are auto-generated by the setup script
```

#### Frontend Configuration (`.env`)

Update the backend URL in `.env`:

```env
BACKEND_URL=https://your-production-backend-url.com
```

### 3. SSL Certificates

For production, replace the self-signed certificates:

```bash
# Place your SSL certificates in the ssl/ directory
cp your-cert.pem ssl/cert.pem
cp your-private-key.pem ssl/key.pem
```

### 4. Update Domain Configuration

Update `nginx.conf` with your actual domain name:

```nginx
server_name your-domain.com www.your-domain.com;
```

## üöÄ Deployment Options

### Option 1: Deploy Everything

```bash
./scripts/deploy.sh --all
```

### Option 2: Deploy Backend Only

```bash
./scripts/deploy.sh --backend
```

### Option 3: Deploy Mobile App Only

```bash
./scripts/deploy.sh --mobile
```

## üê≥ Docker Deployment

The project includes Docker configuration for easy deployment:

### Services Included

- **traillink-backend**: Node.js API server
- **mongodb**: MongoDB database (optional, use if not using Atlas)
- **nginx**: Reverse proxy with SSL termination

### Manual Docker Commands

```bash
# Build the backend image
docker build -t traillink-backend .

# Start all services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

## üì± Mobile App Deployment

### EAS Build Configuration

The project includes three build profiles in `eas.json`:

- **development**: Development builds with dev client
- **preview**: Internal distribution builds
- **production**: App store builds

### Building for App Stores

```bash
# Build for both iOS and Android
eas build --platform all --profile production

# Build for iOS only
eas build --platform ios --profile production

# Build for Android only
eas build --platform android --profile production
```

### Submitting to App Stores

```bash
# Submit to both stores
eas submit --platform all

# Submit to iOS App Store
eas submit --platform ios

# Submit to Google Play Store
eas submit --platform android
```

## üîí Security Considerations

### Environment Variables

- Never commit `.env` files to version control
- Use strong, unique secrets for JWT and session keys
- Rotate secrets regularly in production

### SSL/TLS

- Use valid SSL certificates from a trusted CA
- Enable HSTS headers (configured in nginx.conf)
- Regularly update certificates before expiration

### Database Security

- Use MongoDB Atlas with IP whitelisting
- Enable authentication and use strong passwords
- Regular backups and monitoring

### API Security

- Rate limiting is configured (100 requests per 15 minutes)
- CORS is properly configured
- Security headers are set via Helmet.js

## üìä Monitoring and Logging

### Application Logs

Logs are stored in `backend/logs/`:
- `error.log`: Error-level logs only
- `combined.log`: All application logs

### Health Checks

- Backend health check: `GET /health`
- Docker health checks are configured
- Monitor response times and error rates

### Database Monitoring

- Use MongoDB Atlas monitoring
- Set up alerts for connection issues
- Monitor query performance

## üîÑ CI/CD Pipeline

### GitHub Actions Example

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy TrailLink

on:
  push:
    branches: [main]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to production
        run: |
          # Add your deployment commands here
          ./scripts/deploy.sh --backend

  deploy-mobile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Build and deploy
        run: |
          ./scripts/deploy.sh --mobile
```

## üÜò Troubleshooting

### Common Issues

1. **MongoDB Connection Failed**
   - Check MONGO_URI in backend/.env
   - Verify IP whitelist in MongoDB Atlas
   - Check network connectivity

2. **CORS Errors**
   - Verify CORS_ORIGIN in backend/.env
   - Check frontend URL configuration

3. **SSL Certificate Issues**
   - Verify certificate files exist in ssl/
   - Check certificate expiration
   - Validate certificate chain

4. **EAS Build Failures**
   - Check eas.json configuration
   - Verify Expo account permissions
   - Review build logs in EAS dashboard

### Logs and Debugging

```bash
# View backend logs
docker-compose logs -f traillink-backend

# View all service logs
docker-compose logs -f

# Check container status
docker-compose ps

# Access backend container
docker-compose exec traillink-backend sh
```

## üìà Performance Optimization

### Backend Optimization

- Enable gzip compression in nginx
- Use Redis for session storage (optional)
- Implement database indexing
- Monitor and optimize slow queries

### Frontend Optimization

- Enable Hermes engine for Android
- Optimize bundle size with Metro
- Implement code splitting
- Use image optimization

## üîÑ Updates and Maintenance

### Backend Updates

1. Update dependencies: `npm update`
2. Test in staging environment
3. Deploy with zero downtime using Docker

### Mobile App Updates

1. Update app version in app.config.js
2. Build new version: `eas build`
3. Submit to app stores: `eas submit`

### Database Maintenance

- Regular backups
- Index optimization
- Performance monitoring
- Security updates

## üìû Support

For deployment issues:

1. Check the troubleshooting section above
2. Review application logs
3. Check service status and health endpoints
4. Consult the main README.md for application-specific details

---

**Note**: This deployment guide assumes a production environment. For development, you can use the existing local setup with `npm start` for the frontend and `npm run dev` for the backend.